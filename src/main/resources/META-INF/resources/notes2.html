<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Notes service</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/wingcss/0.1.8/wing.min.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Load AngularJS -->
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
  <script type="text/javascript">

      function createFastNote() {
          createFastNoteFromBytes(document.getElementById("noteObject").value);
      }

      function createFastNoteFromBytes(bytes) {
          let data = {"text": bytes};
          console.info("sending data", data);
          postData("note", data).then(_ => loadNotesList());
      }

      async function loadNotesList() {
          const noteItemTpl = document.getElementById("noteItemTpl");
          const notesList = document.getElementById("notesList");

          const notes = await getData("note");

          notesList.innerText = "";
          notes.forEach(n => {
              const noteItem = document.importNode(noteItemTpl.content, true);
              noteItem.querySelector("div div").innerHTML = n.text;
              notesList.append(noteItem);
          });
      }

      async function cleanUp() {
          await del('note');
          const notesList = document.getElementById("notesList");
          notesList.innerText = "";
      }

      function postData(url = ``, data = {}) {
          return fetch(url, {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify(data), // body data type must match "Content-Type" header
          })
              .then(response => inspectResponse(response))
              .then(response => response.json());
      }

      function del(url) {
          return fetch(url, {
              method: "DELETE",
          }).then(response => inspectResponse(response))
      }

      function getData(url = ``, data = {}) {
          return fetch(url, {
              method: "GET"
          })
              .then(response => inspectResponse(response))
              .then(response => response.json());
      }

      function inspectResponse(response) {
          console.info(response.status, response.headers);
          return response;
      }

      window.onload = function () {

          // Get file data on drop
          const dropZone = document.getElementById('noteObject');

          // Optional.   Show the copy icon when dragging over.  Seems to only work for chrome.
          dropZone.addEventListener('dragover', function (e) {
              e.stopPropagation();
              e.preventDefault();
              e.dataTransfer.dropEffect = 'copy';
          });

          dropZone.addEventListener('drop', function (e) {
              e.stopPropagation();
              e.preventDefault();
              var files = e.dataTransfer.files; // Array of all files

              for (var i = 0, file; file = files[i]; i++) {
                  // if (file.type.match(/image.*/)) {
                  var reader = new FileReader();

                  reader.onload = function (e2) {
                      // finished reading file data.
                      const img = document.createElement('img');
                      document.getElementById("noteObject").value = e2.target.result;
                      createFastNoteFromBytes(e2.target.result);
                  };

                  reader.readAsDataURL(file); // start reading the file data.
                  // }
              }
          })
      };

  </script>
</head>
<body>
<div class="container">
  <div class="row">
    <div class="col-6">
      <input id="noteObject" type="text" placeholder="note" size="60"/>
    </div>
    <div class="col-6">
      <button onclick="createFastNote()">Save</button>
    </div>
  </div>

  <div id="notesList">

  </div>

  <template id="noteItemTpl">
    <div class="row">
      <div class="col-12"></div>
    </div>
  </template>

  <div class="row">
    <button onclick="cleanUp()">Clean up</button>
  </div>

  <script>
      loadNotesList();
  </script>
</div>

</body>
</html>
